{% extends 'plugins/plugin_base.html' %}{% load i18n bootstrap_pagination humanize static sort_anchor range_filter thumbnail %}
{% load local_timezone %}
{% load plugin_utils %}
{% block extrajs %}
  <script type="text/javascript" src="{% static "js/jquery.cookie.js" %}"></script>
  <script language="javascript">
   $(document).ready(function () {
     if ($('tr > th > a:contains("Downloads ↓")'))
     {
       $('tr > th > a:contains("Downloads ↓")').html('<img src="{% static "images/down_16.png" %}" />&darr;');
     }
     if ( $('tr > th > a:contains("Downloads ↑")') )
     {
       $('tr > th > a:contains("Downloads ↑")').html('<img src="{% static "images/down_16.png" %}" />&uarr;');
     }
     $('tr > th > a:contains("Downloads")').html('<img src="{% static "images/down_16.png" %}" />');

     if ($('tr > th > a:contains("Featured ↓")'))
     {
       $('tr > th > a:contains("Featured ↓")').html('<img src="{% static "images/star_16.png" %}" />&darr;');
     }
     if ( $('tr > th > a:contains("Featured ↑")') )
     {
       $('tr > th > a:contains("Featured ↑")').html('<img src="{% static "images/star_16.png" %}" />&uarr;');
     }
     $('tr > th > a:contains("Featured")').html('<img src="{% static "images/star_16.png" %}" />');
   });

    function toggle_desc(){
        jQuery('.plugin-description').toggle('slow', function(){
            jQuery.cookie('plugin-description-visible', jQuery('.plugin-description').is(':visible'));
        });
        if(jQuery('.plugin-description').hasClass('hidden')){
            jQuery('.plugin-description').removeClass('hidden');
        } else {
            jQuery('.plugin-description').addClass('hidden');
        }
        return false;
    }

    // Start with descriptions visible
    jQuery(function(){
        if (jQuery.cookie('plugin-description-visible') == 'true'){
            toggle_desc();
        }
    });


  </script>
{% endblock %}
{% block content %}
    <h2>{% if title %}{{title}}{% else %}{% trans "All plugins" %}{% endif %}</h2>
    {# Filtered views menu #}
    {% if object_list.count %}
    
    <span>
        {% blocktrans with records_count=page_obj.paginator.count %}{{ records_count }} records found{% endblocktrans %}
    </span>
    <div class="field has-addons is-justify-content-center">
        <p class="control">
            <button id="grid-view-btn" class="button is-small is-info">
                <span class="icon is-small">
                    <i class="fas fa-th"></i>
                </span>
                <span>Grid View</span>
            </button>
        </p>
        <p class="control">
            <button id="table-view-btn" class="button is-small">
                <span class="icon is-small">
                    <i class="fas fa-table"></i>
                </span>
                <span>Table View</span>
            </button>
        </p>
    </div>

    <div id="grid-view" class="columns is-multiline plugins-list-grid">
        {% for object in object_list %}
        <div class="
        column
        is-medium     
        is-half-tablet
        is-half-desktop
        is-one-quarter-widescreen
        is-one-third-fullhd">
            <div 
                class="
                    card 
                    is-flex 
                    is-flex-direction-column 
                    is-justify-content-space-between 
                    {% if object.deprecated %} has-background-danger-light{% endif %}
                "
                onclick="window.location.href='{% url "plugin_detail" object.package_name %}';"
                >
                <div class="card-content is-flex is-flex-direction-column is-justify-content-space-between" style="height: 100%;">
                    <div class="media">
                        <div class="media-left">
                            {% if object.icon and object.icon.file and object.icon|is_image_valid %}
                                {% with image_extension=object.icon.name|file_extension %}
                                    {% if image_extension == 'svg' %}
                                        <figure class="image is-48x48 m-0">
                                            <img alt="{% trans "Plugin icon" %}" src="{{ object.icon.url }}" />
                                        </figure>
                                    {% else %}
                                        {% thumbnail object.icon "256x256" format="PNG" as im %}
                                            <figure class="image is-48x48 m-0">
                                                <img alt="{% trans "Plugin icon" %}" src="{{ im.url }}" />
                                            </figure>
                                        {% endthumbnail %}
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <figure class="image is-48x48 m-0">
                                    <img src="{% static "images/large-logo.svg" %}" alt="{% trans "Plugin icon" %}" />
                                </figure>
                            {% endif %}
                        </div>
                        <div class="media-content">
                            <p class="title is-5">{{ object.name }}</p>
                            <p class="subtitle is-7 author">{% trans "by" %} 
                                <a title="{% trans "See all plugins by"%} {{ object.author }}" href="{% url "author_plugins" object.author %}">
                                    {{ object.author }}
                                </a>
                            </p>
                        </div>
                    </div>
                    <div class="content mb-0">
                        <p>{{ object.description|truncatewords:20 }}</p>

                    </div>
                    <p style="height: 100%;"></p>
                    <div class="content mb-0">

                        <div class="columns mt-3">
                            <p class="column p-1">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                    <span>{{ object.latest_version_date|local_timezone:"SHORT_NATURAL_DAY" }}</span>
                                </span>
                            </p>
                            <div class="column p-1">
                                <div class="star-ratings">
                                    <span style="width:{% widthratio object.average_vote 5 100 %}%" class="rating"></span>
                                </div> ({{ object.rating_votes }})
                            </div>
                        </div>
                    </div>
                </div>

                <footer class="card-footer">
                    <a href="{% if object.stable %}{{ object.stable.get_download_url }}{% else %}{{ object.experimental.get_download_url }}{% endif %}" class="card-footer-item">
                        <span class="icon">
                            <i class="fas fa-download"></i>
                        </span>
                        <span>Download</span>
                    </a>
                    <p class="card-footer-item m-0">
                        <span class="icon">
                            <i class="fas fa-download"></i>
                        </span>
                        <span>{{ object.downloads|intcomma }}</span>
                    </p>
                </footer>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="table-view" class="table_container box-content is-hidden">
        <table class="table plugins-list-table">
            <thead>
                <tr>
                    <th class="pt-3 pb-3">&nbsp;</th>
                    <th class="pt-3 pb-3">{% anchor name %}</th>
                    {% if not user.is_anonymous %}<th class="pt-3 pb-3"><img title="{% trans "Approved" %}" src="{% static "images/tick_16.png" %}" alt="{% trans "Approved" %}"/></th>{% endif %}
                    <th class="pt-3 pb-3">{% anchor downloads %}</th>
                    <th class="pt-3 pb-3">{% anchor author "Author" %}</th>
                    <th class="pt-3 pb-3">{% anchor latest_version_date "Latest Plugin Version" %}</th>
                    <th class="pt-3 pb-3">{% anchor average_vote "Stars (votes)" %}</th>
                    {% if user.is_authenticated %}<th colspan="2" class="pt-3 pb-3">{% trans "Manage" %}</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for object in object_list %}
                <tr class="pmain {% if object.deprecated %} has-background-danger-light{% endif %}" id="pmain{{object.pk}}" onclick="window.location.href='{% url "plugin_detail" object.package_name %}';">
                    <td style="min-width: 46px;">
                    {% if object.icon and object.icon.file and object.icon|is_image_valid %}
                        {% with image_extension=object.icon.name|file_extension %}
                            {% if image_extension == 'svg' %}
                                <img class="pull-right plugin-icon" alt="{% trans "Plugin icon" %}" src="{{ object.icon.url }}" width="24" height="24" />
                            {% else %}
                                {% thumbnail object.icon "24x24" format="PNG" as im %}
                                    <img class="plugin-icon" alt="{% trans "Plugin icon" %}" src="{{ im.url }}" width="{{ im.x }}" height="{{ im.y }}" />
                                {% endthumbnail %}
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <img height="32" width="32" class="plugin-icon" src="{% static "images/qgis-icon-32x32.png" %}" alt="{% trans "Plugin icon" %}" />
                    {% endif %}</td>
                    <td>
                        <span class="plugin-name">
                            {{ object.name }}
                        </span>
                    </td>
                    {% if not user.is_anonymous %}<td>{% if object.approved %}<img src="{% static "images/tick_16.png" %}" />{% else %}&mdash;{% endif %}</td>{% endif %}
                    <td>{{ object.downloads }}</td>
                    {% if object.author %}
                    <td>
                        <a class="author" title="{% trans "See all plugins by"%} {{ object.author }}" href="{% url "author_plugins" object.author %}">
                            {{ object.author }}
                        </a>
                    </td>
                    {% endif %}
                    <td>{{ object.latest_version_date|local_timezone:"SHORT_NATURAL_DAY" }}</td>
                    <td><div><div class="star-ratings"><span style="width:{% widthratio object.average_vote 5 100 %}%" class="rating"></span></div> ({{ object.rating_votes }})</div></td>
                    {% if user.is_authenticated %}
                        {% if user in object.editors or user.is_staff %}
                        <td>
                            <div class="field has-addons">
                                <p class="control mb-0">
                                    <a class="button is-success is-small is-outlined" href="{% url "plugin_update" object.package_name %}">
                                        <i class="fa-solid fa-pencil" title="{% trans "Edit" %}"></i>
                                    </a>
                                </p>
                                <p class="control mb-0">
                                    <a class="button is-danger is-small is-outlined" class="delete" href="{% url "plugin_delete" object.package_name %}">
                                        <i class="fa-solid fa-trash" title="{% trans "Delete" %}"></i>
                                    </a>
                                </p>
                            </div>
                        </td>
                        {% endif %}
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <script>
        document.getElementById('table-view-btn').addEventListener('click', function() {
            document.getElementById('table-view').classList.remove('is-hidden');
            document.getElementById('grid-view').classList.add('is-hidden');
            this.classList.add('is-info');
            document.getElementById('grid-view-btn').classList.remove('is-info');
        });

        document.getElementById('grid-view-btn').addEventListener('click', function() {
            document.getElementById('grid-view').classList.remove('is-hidden');
            document.getElementById('table-view').classList.add('is-hidden');
            this.classList.add('is-info');
            document.getElementById('table-view-btn').classList.remove('is-info');
        });
    </script>
    <div class="mt-3 mb-3">
    {% include 'plugins/list_pagination.html' %}
    </div>
    <div class="notification is-danger is-light is-light">
        <i class="fas fa-info mr-3"></i>
        {% trans "Deprecated plugins are printed in red." %}
    </div>
    {% else %}
    {% block plugins_message %}
    <div class="notification">
        <i class="fas fa-info mr-3"></i>
        {% trans "This list is empty!" %}
    </div>
    {% endblock %}
    {% endif %}
    <script type="text/javascript">
        jQuery('.popover').popover();
    </script>
{% endblock %}
